name: "🛠️ RustDesk手动构建（编码问题修复版）"

on:
  workflow_dispatch:
    inputs:
      构建类型:
        description: "选择构建模式"
        required: true
        type: choice
        options: ["release", "debug"]
        default: "release"
      强制清理:
        description: "彻底清除缓存（修复编码问题）"
        type: boolean
        default: false

env:
  # 中文环境保障
  LC_ALL: "zh_CN.UTF-8"
  VCPKG_ROOT: "C:\\vcpkg_build"
  BUILD_DIR: "C:\\rustdesk_output"  # 固定英文输出路径

jobs:
  构建:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
    - name: "1. 环境净化"
      if: ${{ inputs.强制清理 }}
      shell: cmd
      run: |
        chcp 65001 >nul
        rd /s/q "%VCPKG_ROOT%" 2>nul
        rd /s/q "%BUILD_DIR%" 2>nul
        rd /s/q target 2>nul

    - name: "2. 初始化vcpkg"
      shell: cmd
      run: |
        chcp 65001 >nul
        if not exist "%VCPKG_ROOT%\\vcpkg.exe" (
          git clone https://github.com/microsoft/vcpkg "%VCPKG_ROOT%"
          cd "%VCPKG_ROOT%"
          bootstrap-vcpkg.bat -disableMetrics
        )
        setx PATH "%PATH%;%VCPKG_ROOT%"

    - name: "3. 安装依赖（安全模式）"
      shell: cmd
      run: |
        cd "%VCPKG_ROOT%"
        vcpkg install --triplet x64-windows ^
          --clean-after-build ^
          --recurse ^
          libvpx libyuv openssl

    - name: "4. 安全构建"
      shell: cmd
      run: |
        set CARGO_TARGET_DIR=%BUILD_DIR%
        cargo build --%{{ inputs.构建类型 }}% ^
          --target x86_64-pc-windows-msvc ^
          --config "build.rustflags=['-C', 'target-feature=+crt-static']"
        
        if not exist "%BUILD_DIR%\\x86_64-pc-windows-msvc\\%{{ inputs.构建类型 }}%\\rustdesk.exe" (
          echo ::error::构建失败：未检测到输出文件
          dir /s "%BUILD_DIR%"
          exit 1
        )

    - name: "5. 打包成品"
      uses: actions/upload-artifact@v4
      with:
        name: RustDesk_%{{ inputs.构建类型 }}%_%{{ github.run_number }}
        path: |
          %BUILD_DIR%/x86_64-pc-windows-msvc/%{{ inputs.构建类型 }}%/rustdesk.exe
          %BUILD_DIR%/x86_64-pc-windows-msvc/%{{ inputs.构建类型 }}%/*.dll
        retention-days: 7
