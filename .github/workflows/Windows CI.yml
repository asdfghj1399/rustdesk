name: "ğŸš€ RustDesk Windows Build (Verified)"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Select build configuration"
        required: true
        default: "release"
        type: choice
        options: ["release", "debug"]

env:
  VCPKG_ROOT: "C:\\vcpkg"
  BUILD_DIR: "C:\\build_output"
  WORKSPACE: "${{ github.workspace }}\\rustdesk"  # æ˜ç¡®é¡¹ç›®å­ç›®å½•

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
    - name: "1ï¸âƒ£ Checkout Repository (Full Depth)"
      uses: actions/checkout@v4
      with:
        path: rustdesk  # æ˜ç¡®æ£€å‡ºåˆ°å­ç›®å½•
        submodules: recursive
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    - name: "2ï¸âƒ£ Validate Project Structure"
      shell: powershell
      run: |
        # ä¸¥æ ¼éªŒè¯é¡¹ç›®ç»“æ„
        $requiredFiles = @("Cargo.toml", "src/main.rs")
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path "$env:WORKSPACE\$file")) {
            Write-Output "::error::Missing required file: $file"
            Get-ChildItem -Recurse "$env:WORKSPACE"
            exit 1
          }
        }
        echo "PROJECT_VALIDATED=true" >> $env:GITHUB_ENV

    - name: "3ï¸âƒ£ Setup Build Environment"
      shell: powershell
      run: |
        # åˆå§‹åŒ–æ„å»ºç›®å½•
        New-Item -ItemType Directory -Path "$env:BUILD_DIR" -Force | Out-Null
        
        # å®‰è£…vcpkgï¼ˆå¸¦é‡è¯•ï¼‰
        $maxRetries = 3
        $retryCount = 0
        while ($retryCount -lt $maxRetries) {
          try {
            if (-not (Test-Path "$env:VCPKG_ROOT\vcpkg.exe")) {
              git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
              & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
            }
            break
          } catch {
            $retryCount++
            if ($retryCount -eq $maxRetries) { throw }
            Start-Sleep -Seconds 10
          }
        }

    - name: "4ï¸âƒ£ Install Dependencies"
      shell: powershell
      working-directory: ${{ env.WORKSPACE }}
      run: |
        & "$env:VCPKG_ROOT\vcpkg" install @(
          "libvpx",
          "libyuv",
          "openssl"
        ) --triplet x64-windows --clean-after-build

    - name: "5ï¸âƒ£ Build Project"
      shell: powershell
      working-directory: ${{ env.WORKSPACE }}
      run: |
        $env:CARGO_TARGET_DIR = "$env:BUILD_DIR"
        
        # å¸¦è¯Šæ–­ä¿¡æ¯çš„æ„å»º
        cargo build --${{ inputs.build_type }} `
          --target x86_64-pc-windows-msvc `
          -v --message-format=json | Tee-Object -FilePath build_log.json
        
        # è§£ææ„å»ºæ—¥å¿—éªŒè¯ç»“æœ
        if (-not (Test-Path "$env:BUILD_DIR\x86_64-pc-windows-msvc\${{ inputs.build_type }}\rustdesk.exe")) {
          Write-Output "::error::Build Failed - Diagnostics:"
          Get-Content build_log.json | Where-Object { $_ -match '"reason":"compiler-message"' }
          exit 1
        }

    - name: "6ï¸âƒ£ Upload Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-${{ inputs.build_type }}-${{ github.run_number }}
        path: |
          ${{ env.BUILD_DIR }}/x86_64-pc-windows-msvc/${{ inputs.build_type }}/rustdesk.exe
          ${{ env.BUILD_DIR }}/x86_64-pc-windows-msvc/${{ inputs.build_type }}/*.dll
        retention-days: 7
