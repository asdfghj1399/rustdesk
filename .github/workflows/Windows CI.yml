name: "ğŸš€ RustDeskä¸­æ–‡ç¯å¢ƒæ„å»º"

env:
  # å¼ºåˆ¶ä½¿ç”¨ç®€ä½“ä¸­æ–‡ç¼–ç 
  LC_ALL: "zh_CN.UTF-8"  
  LANG: "zh_CN.UTF-8"
  VCPKG_ROOT: "C:\\rustdesk_vcpkg"  # é¿å…ç©ºæ ¼å’Œä¸­æ–‡è·¯å¾„

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: "1. è®¾ç½®çº¯å‡€ç¯å¢ƒ"
      shell: cmd
      run: |
        chcp 65001
        set PATH=%PATH%;C:\Program Files\Git\usr\bin
        rd /s/q target 2>nul

    - name: "2. å®‰è£…vcpkg"
      shell: cmd
      run: |
        if not exist "%VCPKG_ROOT%" (
          git clone https://github.com/microsoft/vcpkg "%VCPKG_ROOT%"
          cd "%VCPKG_ROOT%"
          bootstrap-vcpkg.bat -disableMetrics
        )
        setx PATH "%PATH%;%VCPKG_ROOT%"

    - name: "3. å®‰è£…ä¾èµ–åº“"
      shell: cmd
      run: |
        cd "%VCPKG_ROOT%"
        vcpkg install --triplet x64-windows ^
          libvpx libyuv openssl ^
          --clean-after-build

    - name: "4. æ„å»ºé¡¹ç›®ï¼ˆä¸­æ–‡å…¼å®¹æ¨¡å¼ï¼‰"
      shell: cmd
      run: |
        set CARGO_TARGET_DIR=%CD%\build_output
        cargo build --release ^
          --target x86_64-pc-windows-msvc ^
          --config "build.rustflags=['-C', 'target-feature=+crt-static']"
        
        if not exist "%CARGO_TARGET_DIR%\\x86_64-pc-windows-msvc\\release\\rustdesk.exe" (
          echo ::error::æ„å»ºå¤±è´¥ï¼šæœªç”ŸæˆEXEæ–‡ä»¶
          exit 1
        )

    - name: "5. æ‰“åŒ…æˆæœç‰©"
      uses: actions/upload-artifact@v4
      with:
        name: æœ€ç»ˆæˆå“
        path: |
          build_output/x86_64-pc-windows-msvc/release/rustdesk.exe
          build_output/x86_64-pc-windows-msvc/release/*.dll
