name: "ğŸš€ RustDeskæ‰‹åŠ¨è§¦å‘æ„å»ºï¼ˆä¸­æ–‡ä¼˜åŒ–ç‰ˆï¼‰"

on:
  # æ‰‹åŠ¨è§¦å‘é…ç½®ï¼ˆå·²æ·»åŠ ï¼‰
  workflow_dispatch:
    inputs:
      æ„å»ºæ¨¡å¼:
        description: "é€‰æ‹©æ„å»ºç±»å‹"
        required: true 
        default: "release"
        type: choice
        options: 
          - "release"
          - "debug"
      æ¸…ç†ç¼“å­˜:
        description: "æ˜¯å¦å½»åº•æ¸…ç†æ„å»ºç¼“å­˜"
        type: boolean
        default: false

env:
  # ä¸­æ–‡ç¯å¢ƒä¸“ç”¨é…ç½®
  LC_ALL: "zh_CN.UTF-8"
  VCPKG_ROOT: "C:\\rustdesk_build"

jobs:
  æ„å»ºä»»åŠ¡:
    runs-on: windows-latest
    
    steps:
    - name: "1. ç¯å¢ƒåˆå§‹åŒ–"
      shell: cmd
      run: |
        chcp 65001
        @echo æ­£åœ¨å‡†å¤‡æ„å»ºç¯å¢ƒ...
        if %{{ inputs.æ¸…ç†ç¼“å­˜ }}% == true (
          rd /s/q "%VCPKG_ROOT%" 2>nul
          rd /s/q target 2>nul
        )

    - name: "2. å®‰è£…æ„å»ºå·¥å…·"
      shell: cmd
      run: |
        if not exist "%VCPKG_ROOT%\\vcpkg.exe" (
          git clone https://github.com/microsoft/vcpkg "%VCPKG_ROOT%"
          cd "%VCPKG_ROOT%"
          bootstrap-vcpkg.bat -disableMetrics
        )
        setx PATH "%PATH%;%VCPKG_ROOT%"

    - name: "3. å®‰è£…ä¾èµ–åº“"
      shell: cmd
      run: |
        cd "%VCPKG_ROOT%"
        vcpkg install --triplet x64-windows ^
          libvpx libyuv openssl ^
          --clean-after-build

    - name: "4. ç¼–è¯‘é¡¹ç›®"
      shell: cmd
      run: |
        set CARGO_TARGET_DIR=%CD%\\build_output
        cargo build --%{{ inputs.æ„å»ºæ¨¡å¼ }}% ^
          --target x86_64-pc-windows-msvc ^
          --config "build.rustflags=['-C', 'target-feature=+crt-static']"
        
        if not exist "%CARGO_TARGET_DIR%\\x86_64-pc-windows-msvc\\%{{ inputs.æ„å»ºæ¨¡å¼ }}%\\rustdesk.exe" (
          echo ::error::ç¼–è¯‘å¤±è´¥ï¼šæœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
          exit 1
        )

    - name: "5. æ‰“åŒ…æˆå“"
      uses: actions/upload-artifact@v4
      with:
        name: RustDeskæˆå“_%{{ github.run_number }}
        path: |
          build_output/x86_64-pc-windows-msvc/%{{ inputs.æ„å»ºæ¨¡å¼ }}%/rustdesk.exe
          build_output/x86_64-pc-windows-msvc/%{{ inputs.æ„å»ºæ¨¡å¼ }}%/*.dll
