name: "🚀 RustDesk中文环境构建"

env:
  # 强制使用简体中文编码
  LC_ALL: "zh_CN.UTF-8"  
  LANG: "zh_CN.UTF-8"
  VCPKG_ROOT: "C:\\rustdesk_vcpkg"  # 避免空格和中文路径

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: "1. 设置纯净环境"
      shell: cmd
      run: |
        chcp 65001
        set PATH=%PATH%;C:\Program Files\Git\usr\bin
        rd /s/q target 2>nul

    - name: "2. 安装vcpkg"
      shell: cmd
      run: |
        if not exist "%VCPKG_ROOT%" (
          git clone https://github.com/microsoft/vcpkg "%VCPKG_ROOT%"
          cd "%VCPKG_ROOT%"
          bootstrap-vcpkg.bat -disableMetrics
        )
        setx PATH "%PATH%;%VCPKG_ROOT%"

    - name: "3. 安装依赖库"
      shell: cmd
      run: |
        cd "%VCPKG_ROOT%"
        vcpkg install --triplet x64-windows ^
          libvpx libyuv openssl ^
          --clean-after-build

    - name: "4. 构建项目（中文兼容模式）"
      shell: cmd
      run: |
        set CARGO_TARGET_DIR=%CD%\build_output
        cargo build --release ^
          --target x86_64-pc-windows-msvc ^
          --config "build.rustflags=['-C', 'target-feature=+crt-static']"
        
        if not exist "%CARGO_TARGET_DIR%\\x86_64-pc-windows-msvc\\release\\rustdesk.exe" (
          echo ::error::构建失败：未生成EXE文件
          exit 1
        )

    - name: "5. 打包成果物"
      uses: actions/upload-artifact@v4
      with:
        name: 最终成品
        path: |
          build_output/x86_64-pc-windows-msvc/release/rustdesk.exe
          build_output/x86_64-pc-windows-msvc/release/*.dll
