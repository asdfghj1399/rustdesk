name: "ğŸ› ï¸ RustDeskæ‰‹åŠ¨æ„å»ºï¼ˆç¼–ç é—®é¢˜ä¿®å¤ç‰ˆï¼‰"

on:
  workflow_dispatch:
    inputs:
      æ„å»ºç±»å‹:
        description: "é€‰æ‹©æ„å»ºæ¨¡å¼"
        required: true
        type: choice
        options: ["release", "debug"]
        default: "release"
      å¼ºåˆ¶æ¸…ç†:
        description: "å½»åº•æ¸…é™¤ç¼“å­˜ï¼ˆä¿®å¤ç¼–ç é—®é¢˜ï¼‰"
        type: boolean
        default: false

env:
  # ä¸­æ–‡ç¯å¢ƒä¿éšœ
  LC_ALL: "zh_CN.UTF-8"
  VCPKG_ROOT: "C:\\vcpkg_build"
  BUILD_DIR: "C:\\rustdesk_output"  # å›ºå®šè‹±æ–‡è¾“å‡ºè·¯å¾„

jobs:
  æ„å»º:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
    - name: "1. ç¯å¢ƒå‡€åŒ–"
      if: ${{ inputs.å¼ºåˆ¶æ¸…ç† }}
      shell: cmd
      run: |
        chcp 65001 >nul
        rd /s/q "%VCPKG_ROOT%" 2>nul
        rd /s/q "%BUILD_DIR%" 2>nul
        rd /s/q target 2>nul

    - name: "2. åˆå§‹åŒ–vcpkg"
      shell: cmd
      run: |
        chcp 65001 >nul
        if not exist "%VCPKG_ROOT%\\vcpkg.exe" (
          git clone https://github.com/microsoft/vcpkg "%VCPKG_ROOT%"
          cd "%VCPKG_ROOT%"
          bootstrap-vcpkg.bat -disableMetrics
        )
        setx PATH "%PATH%;%VCPKG_ROOT%"

    - name: "3. å®‰è£…ä¾èµ–ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰"
      shell: cmd
      run: |
        cd "%VCPKG_ROOT%"
        vcpkg install --triplet x64-windows ^
          --clean-after-build ^
          --recurse ^
          libvpx libyuv openssl

    - name: "4. å®‰å…¨æ„å»º"
      shell: cmd
      run: |
        set CARGO_TARGET_DIR=%BUILD_DIR%
        cargo build --%{{ inputs.æ„å»ºç±»å‹ }}% ^
          --target x86_64-pc-windows-msvc ^
          --config "build.rustflags=['-C', 'target-feature=+crt-static']"
        
        if not exist "%BUILD_DIR%\\x86_64-pc-windows-msvc\\%{{ inputs.æ„å»ºç±»å‹ }}%\\rustdesk.exe" (
          echo ::error::æ„å»ºå¤±è´¥ï¼šæœªæ£€æµ‹åˆ°è¾“å‡ºæ–‡ä»¶
          dir /s "%BUILD_DIR%"
          exit 1
        )

    - name: "5. æ‰“åŒ…æˆå“"
      uses: actions/upload-artifact@v4
      with:
        name: RustDesk_%{{ inputs.æ„å»ºç±»å‹ }}%_%{{ github.run_number }}
        path: |
          %BUILD_DIR%/x86_64-pc-windows-msvc/%{{ inputs.æ„å»ºç±»å‹ }}%/rustdesk.exe
          %BUILD_DIR%/x86_64-pc-windows-msvc/%{{ inputs.æ„å»ºç±»å‹ }}%/*.dll
        retention-days: 7
