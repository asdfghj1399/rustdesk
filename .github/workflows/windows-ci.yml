name: "üõ†Ô∏è RustDesk Windows CI (Stable)"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: "Build configuration"
        required: true
        default: "release"
        type: choice
        options: ["release", "debug"]

env:
  VCPKG_ROOT: "C:\\vcpkg"
  VCPKG_BINARY_SOURCES: "clear;default,readwrite"  # ‰øÆÂ§çÁºìÂ≠òÈÖçÁΩÆ
  VCPKG_DISABLE_METRICS: "true"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
    - name: "1Ô∏è‚É£ Clean Workspace"
      shell: powershell
      run: |
        # Ê∏ÖÁêÜÊóßÊûÑÂª∫ÊÆãÁïô
        Remove-Item -Recurse -Force "$env:VCPKG_ROOT" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "target" -ErrorAction SilentlyContinue

    - name: "2Ô∏è‚É£ Checkout Code"
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: src

    - name: "3Ô∏è‚É£ Setup vcpkg"
      shell: powershell
      run: |
        if (-not (Test-Path "$env:VCPKG_ROOT\vcpkg.exe")) {
          git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
        }
        echo "$env:VCPKG_ROOT" >> $env:GITHUB_PATH

    - name: "4Ô∏è‚É£ Install Dependencies (Fixed)"
      shell: powershell
      working-directory: src
      run: |
        # Á¶ÅÁî®ÈóÆÈ¢òÈÖçÁΩÆ
        $env:VCPKG_FEATURE_FLAGS = "-versions"
        
        & "$env:VCPKG_ROOT\vcpkg" install @(
          "libvpx[core]",
          "libyuv[core]",
          "openssl[core]"
        ) --triplet x64-windows `
          --clean-after-build `
          --recurse `
          --x-asset-sources=clear

    - name: "5Ô∏è‚É£ Build Project"
      shell: powershell
      working-directory: src
      run: |
        cargo build --${{ inputs.build_type }} `
          --target x86_64-pc-windows-msvc `
          --config "build.rustflags=['-C', 'target-feature=+crt-static']"

    - name: "6Ô∏è‚É£ Upload Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-${{ inputs.build_type }}
        path: |
          src/target/x86_64-pc-windows-msvc/${{ inputs.build_type }}/rustdesk.exe
          src/target/x86_64-pc-windows-msvc/${{ inputs.build_type }}/*.dll
