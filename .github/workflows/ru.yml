name: Build RustDesk (Windows)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  RUST_VERSION: "1.75.0"
  FLUTTER_VERSION: "3.24.5"
  PYTHON_VERSION: "3.9.13"  # 使用长期支持版本
  VERSION: "1.3.9"
  BUILD_DIR: "target/release"
  FLUTTER_BUILD_DIR: "flutter/build/windows/x64/runner/Release"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        flutter-version: ${{ env.FLUTTER_VERSION }}

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc
        override: true
        components: rustfmt

    - name: Install system dependencies (Fixed)
      shell: powershell
      run: |
        # 1. 设置执行策略和安全协议
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12

        # 2. 安装Chocolatey（带重试）
        $maxRetries = 3
        $retryCount = 0
        do {
            try {
                if (-not (Test-Path "$env:ProgramData\chocolatey\choco.exe")) {
                    Write-Output "Installing Chocolatey (attempt $($retryCount+1))"
                    iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
                }
                break
            } catch {
                $retryCount++
                if ($retryCount -ge $maxRetries) { throw }
                Start-Sleep -Seconds (10 * $retryCount)
            }
        } while ($true)

        # 3. 更新环境变量
        Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1" -Force
        $env:PATH = "$env:PATH;C:\ProgramData\chocolatey\bin;C:\Program Files\CMake\bin"

        # 4. 安装依赖（使用最新稳定版本）
        choco install -y cmake git --no-progress
        choco install -y python --version=$env:PYTHON_VERSION --no-progress
        choco install -y llvm --version=15.0.6 --no-progress
        
        # 5. 手动安装NASM（不使用Chocolatey）
        $ProgressPreference = 'SilentlyContinue'
        Invoke-WebRequest -Uri "https://www.nasm.us/pub/nasm/releasebuilds/2.16.01/win64/nasm-2.16.01-win64.zip" -OutFile "nasm.zip"
        Expand-Archive -Path "nasm.zip" -DestinationPath "C:\nasm"
        $env:PATH = "C:\nasm;$env:PATH"

        # 6. 验证安装
        python --version
        nasm --version
        cmake --version

    - name: Build Rust backend
      shell: powershell
      run: |
        cd rust
        cargo build --release --features hwcodec,vram,flutter
        if (-not (Test-Path "../$env:BUILD_DIR/rustdesk.exe")) {
            throw "Rust build failed - rustdesk.exe not found"
        }

    - name: Build Flutter frontend
      shell: powershell
      run: |
        flutter pub get
        flutter build windows --release
        if (-not (Test-Path "$env:FLUTTER_BUILD_DIR/rustdesk.exe")) {
            throw "Flutter build failed - rustdesk.exe not found"
        }

    - name: Merge builds
      shell: powershell
      run: |
        Copy-Item "$env:BUILD_DIR/rustdesk.exe" -Destination "$env:FLUTTER_BUILD_DIR" -Force

    - name: Package artifacts
      shell: powershell
      run: |
        $artifactDir = "release_$env:VERSION"
        New-Item -ItemType Directory -Path $artifactDir -Force
        Copy-Item "$env:FLUTTER_BUILD_DIR/rustdesk.exe" -Destination $artifactDir
        Copy-Item "$env:FLUTTER_BUILD_DIR/*.dll" -Destination $artifactDir
        Compress-Archive -Path "$artifactDir/*" -DestinationPath "rustdesk-$env:VERSION.zip" -Force

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-windows
        path: |
          rustdesk-$env:VERSION.zip
          ${{ env.FLUTTER_BUILD_DIR }}/rustdesk.exe
        retention-days: 7
