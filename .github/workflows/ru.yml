name: RustDesk CI/CD (编码问题修复版)

on:
  workflow_dispatch:
    inputs:
      build-mode:
        description: 'Build Type'
        type: choice
        options: [debug, release]
        default: 'release'

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Environment
      shell: powershell
      run: |
        # 强制设置UTF-8编码环境
        $ErrorActionPreference = 'Stop'
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null

        # 使用ASCII字符输出路径信息
        Write-Output "##[group]Path Configuration"
        Write-Output "Workspace Path: $env:GITHUB_WORKSPACE"
        $currentPath = (Get-Location).Path
        Write-Output "Current Path: $currentPath"
        Write-Output "##[endgroup]"

        # 路径标准化处理
        $buildPath = "$env:GITHUB_WORKSPACE\src" -replace '/', '\'
        if (-not (Test-Path $buildPath)) {
            New-Item -Path $buildPath -ItemType Directory -Force
        }

    - name: Build Project
      shell: powershell
      working-directory: $env:GITHUB_WORKSPACE\src
      run: |
        # 验证编码设置
        Write-Output "##[group]Encoding Status"
        Write-Output "Console Encoding: [$(chcp)]"
        Write-Output "PowerShell Encoding: $([Console]::OutputEncoding.EncodingName)"
        Write-Output "##[endgroup]"

        # 安全构建命令
        try {
            cargo build --${{ inputs.build-mode }}
        } catch {
            Write-Output "::error::Build failed with exit code $LASTEXITCODE"
            exit 1
        }
