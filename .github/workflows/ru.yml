name: Clean Workspace

on:
  workflow_dispatch:

jobs:
  deep-clean:
    runs-on: windows-2022
    steps:
      - name: 停止相关进程
        shell: pwsh
        run: |
          Get-Process | Where-Object { 
              $_.Path -like "*vcpkg*" -or 
              $_.Path -like "*cargo*"
          } | Stop-Process -Force -ErrorAction SilentlyContinue

      - name: 清理系统级目录
        shell: pwsh
        run: |
          $targets = @(
              "C:\vcpkg",
              "${env:ProgramFiles}\vcpkg",
              "${env:LOCALAPPDATA}\vcpkg",
              "${env:TEMP}\vcpkg"
          )
          
          $targets | ForEach-Object {
              if (Test-Path $_) {
                  Write-Output "Removing $_"
                  Remove-Item $_ -Recurse -Force -ErrorAction Continue
              }
          }

      - name: 重置权限
        if: always()
        shell: pwsh
        run: |
          icacls "C:\" /reset /T /C /L /Q
