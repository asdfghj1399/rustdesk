name: RustDesk Windows CI

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: "Full clean rebuild"
        type: boolean
        default: false

env:
  VCPKG_ROOT: "${{ github.workspace }}/vcpkg"  # é¿å…æƒé™é—®é¢˜
  RUSTUP_TOOLCHAIN: "stable-x86_64-pc-windows-msvc"  # æ˜ç¡®æŒ‡å®šå·¥å…·é“¾

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    # 1. æ™ºèƒ½æ¸…ç†ç³»ç»Ÿ
    - name: "ğŸ§¹ Clean Workspace"
      if: ${{ inputs.clean_build }}
      shell: powershell
      run: |
        # å¤šå±‚çº§æ¸…ç†
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE/target" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE/vcpkg" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "$env:RUNNER_TEMP/.cargo" -ErrorAction SilentlyContinue

    # 2. å¿«é€Ÿä»£ç æ£€å‡º
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        submodules: "recursive"
        fetch-depth: 1  # åŠ é€Ÿå…‹éš†

    # 3. Rust ç¯å¢ƒé…ç½®ï¼ˆå›½å†…ä¼˜åŒ–ç‰ˆï¼‰
    - name: "ğŸ¦€ Rust Setup"
      shell: powershell
      run: |
        # è®¾ç½®å›½å†…é•œåƒ
        [System.Environment]::SetEnvironmentVariable('RUSTUP_DIST_SERVER', 'https://rsproxy.cn', [System.EnvironmentVariableTarget]::Process)
        [System.Environment]::SetEnvironmentVariable('RUSTUP_UPDATE_ROOT', 'https://rsproxy.cn/rustup', [System.EnvironmentVariableTarget]::Process)
        
        # å®‰è£… Rustï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰
        $retryCount = 0
        while ($retryCount -lt 3) {
          try {
            iex "& { $(irm https://win.rustup.rs) } -y --default-toolchain $env:RUSTUP_TOOLCHAIN"
            if ($LASTEXITCODE -eq 0) { break }
          } catch {
            $retryCount++
            Start-Sleep -Seconds (10 * $retryCount)
          }
        }
        
        # éªŒè¯å®‰è£…
        rustup default $env:RUSTUP_TOOLCHAIN
        rustup target add x86_64-pc-windows-msvc
        cargo --version

    # 4. vcpkg æé€Ÿå®‰è£…
    - name: "ğŸ“¦ vcpkg Setup"
      shell: powershell
      run: |
        # ä»å›½å†…é•œåƒä¸‹è½½é¢„ç¼–è¯‘vcpkg
        $vcpkgUrl = "https://ghproxy.com/https://github.com/microsoft/vcpkg/releases/download/2024.04.17/vcpkg.exe"
        New-Item -ItemType Directory -Path "$env:VCPKG_ROOT" -Force
        (New-Object Net.WebClient).DownloadFile($vcpkgUrl, "$env:VCPKG_ROOT/vcpkg.exe")
        
        # åˆå§‹åŒ–
        & "$env:VCPKG_ROOT/vcpkg" integrate install
        & "$env:VCPKG_ROOT/vcpkg" version

    # 5. æ™ºèƒ½ä¾èµ–å®‰è£…
    - name: "ğŸ§© Install Dependencies"
      shell: powershell
      env:
        VCPKG_BINARY_SOURCES: "clear;nuget,https://mirrors.ustc.edu.cn/vcpkg,read"
      run: |
        # å…³é”®ä¾èµ–åˆ—è¡¨
        $deps = @(
          "libvpx[core]",
          "libyuv[core]",
          "openssl[core]"
        )
        
        foreach ($dep in $deps) {
          $retry = 0
          while ($retry -lt 3) {
            try {
              & "$env:VCPKG_ROOT/vcpkg" install $dep --triplet=x64-windows --clean-after-build
              if ($LASTEXITCODE -eq 0) { break }
            } catch {
              $retry++
              Start-Sleep -Seconds (30 * $retry)
            }
          }
        }

    # 6. é«˜çº§æ„å»ºç³»ç»Ÿ
    - name: "ğŸ”¨ Build Release"
      shell: powershell
      run: |
        # ç¯å¢ƒé…ç½®
        $env:Path += ";$env:VCPKG_ROOT/installed/x64-windows/bin"
        $env:RUSTFLAGS = "-C target-feature=+crt-static"
        
        # å¹¶è¡Œç¼–è¯‘ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°ï¼‰
        $cpuCount = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
        cargo build --release --target x86_64-pc-windows-msvc -j $cpuCount --verbose
        
        # äº§ç‰©éªŒè¯
        if (-not (Test-Path "target/release/rustdesk.exe")) {
          Write-Output "::error::Build failed!"
          Get-Content Cargo.lock -Tail 20
          exit 1
        }

    # 7. æ™ºèƒ½åˆ¶å“ä¸Šä¼ 
    - name: "ğŸ“¤ Upload Artifact"
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-${{ github.run_id }}
        path: |
          target/release/rustdesk.exe
          target/release/*.dll
        retention-days: 3
