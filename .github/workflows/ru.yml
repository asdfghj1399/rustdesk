name: RustDesk CI (编码修复版)

jobs:
  debug-path:
    runs-on: windows-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Path Debugging
      shell: powershell
      env:
        PS_ENCODING: utf-8  # 显式声明编码
      run: |
        # 设置控制台编码
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001

        # 使用纯ASCII字符显示路径
        $hbbPath = "$env:GITHUB_WORKSPACE\libs\hbb_common"
        Write-Output "##[group]🔍 Path Verification"
        Write-Output "Calculated Path (ASCII): $hbbPath"

        # 安全路径转换
        $normalizedPath = $hbbPath -replace '\\{2,}', '\' -replace '/', '\'
        Write-Output "Normalized Path: $normalizedPath"

        # 缓冲模式路径检测
        try {
            Set-Location $normalizedPath -ErrorAction Stop
            Write-Output "##[info]✅ Successfully accessed: $(Get-Location)"
        } catch {
            Write-Output "::error::❌ Path access failed! Diagnostics below..."
            Get-ChildItem "$env:GITHUB_WORKSPACE\libs" -Recurse | Format-Table FullName
            exit 1
        }

        # 附加诊断信息
        Write-Output "##[debug]Directory contents:"
        Get-ChildItem | Format-Table Name, Length, LastWriteTime
        Write-Output "##[endgroup]"
        
    - name: Build Verification
      shell: pwsh  # 使用PowerShell Core
      run: |
        # UTF-8 BOM 显式声明
        $OutputEncoding = [System.Text.Encoding]::UTF8
        Write-Output "构建路径验证..."
        cargo metadata --manifest-path "$env:GITHUB_WORKSPACE\libs\hbb_common\Cargo.toml" --format-version 1 --verbose
