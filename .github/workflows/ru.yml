name: RustDesk CI/CD (编码问题修复版)

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Perform full clean rebuild'
        type: boolean
        default: false

env:
  WORKSPACE: "${{ github.workspace }}\\src"
  VCPKG_ROOT: "C:\\vcpkg"

jobs:
  setup:
    name: Environment Setup
    runs-on: windows-latest
    steps:
    - name: Create Workspace
      shell: powershell
      run: |
        # 强制设置UTF-8编码环境
        $OutputEncoding = [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null

        # 路径标准化处理
        $workspace = "$env:WORKSPACE" -replace '\\{2,}', '\'
        if (-not (Test-Path $workspace)) {
            New-Item -Path $workspace -ItemType Directory -Force | Out-Null
        }
        Write-Output "##[info]Workspace created: $workspace"

    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: ${{ env.WORKSPACE }}
        clean: true
        fetch-depth: 0

    - name: Fix Permissions
      shell: powershell
      working-directory: ${{ env.WORKSPACE }}
      run: |
        # 统一使用ASCII字符输出
        Write-Output "##[group]Setting File Permissions"
        $fullPath = Convert-Path .
        icacls "$fullPath" /grant "Everyone:(OI)(CI)F" /T /C
        Write-Output "##[info]Permissions set for: $fullPath"
        Write-Output "##[endgroup]"

  build:
    needs: setup
    runs-on: windows-latest
    steps:
    - name: Build Project
      shell: powershell
      working-directory: ${{ env.WORKSPACE }}
      run: |
        # ASCII-only输出
        Write-Output "##[group]Build Process"
        cargo build --release
        if (-not (Test-Path "target\\release\\rustdesk.exe")) {
            Write-Output "::error::Build artifact missing!"
            exit 1
        }
        Write-Output "##[info]Build successful!"
        Write-Output "##[endgroup]"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-bin
        path: |
          ${{ env.WORKSPACE }}\target\release\rustdesk.exe
          ${{ env.WORKSPACE }}\target\release\*.dll
