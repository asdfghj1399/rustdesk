name: Build RustDesk Windows Flutter

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: "Full clean rebuild"
        type: boolean
        default: false

env:
  VCPKG_ROOT: "${{ github.workspace }}/vcpkg"
  VCPKG_COMMIT_ID: "6f29f12e82a8293156836ad81cc9bf5af41fe836" # å›ºå®švcpkgç‰ˆæœ¬
  VERSION: "1.3.9"
  FLUTTER_VERSION: "3.24.5"
  RUST_VERSION: "1.75"
  LLVM_VERSION: "15.0.6"

jobs:
  build-windows:
    runs-on: windows-2022
    timeout-minutes: 120
    
    steps:
    # 1. æ¸…ç†å·¥ä½œåŒºï¼ˆå¯é€‰ï¼‰
    - name: "ğŸ§¹ Clean Workspace"
      if: ${{ inputs.clean_build }}
      shell: powershell
      run: |
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE/vcpkg" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE/target" -ErrorAction SilentlyContinue

    # 2. æ£€å‡ºä»£ç 
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 3. å®‰è£…æ„å»ºå·¥å…·é“¾
    - name: "ğŸ› ï¸ Install Build Tools"
      shell: powershell
      run: |
        # å®‰è£…LLVM
        choco install llvm --version $env:LLVM_VERSION -y
        # å®‰è£…å¿…è¦çš„å·¥å…·
        choco install nasm cmake git -y
        refreshenv

    # 4. å®‰è£…Rust
    - name: "ğŸ¦€ Install Rust"
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc
        components: "rustfmt"

    # 5. å®‰è£…Flutter
    - name: "ğŸ“± Install Flutter"
      uses: subosito/flutter-action@v2
      with:
        channel: "stable"
        flutter-version: ${{ env.FLUTTER_VERSION }}

    # 6. æ›¿æ¢Flutterå¼•æ“ï¼ˆè§£å†³å…¼å®¹æ€§é—®é¢˜ï¼‰
    - name: "ğŸ”§ Replace Flutter Engine"
      shell: powershell
      run: |
        flutter doctor -v
        flutter precache --windows
        Invoke-WebRequest -Uri "https://github.com/rustdesk/engine/releases/download/main/windows-x64-release.zip" -OutFile "windows-x64-release.zip"
        Expand-Archive -Path "windows-x64-release.zip" -DestinationPath "windows-x64-release"
        Move-Item -Force "windows-x64-release/*" "C:/hostedtoolcache/windows/flutter/stable-${{ env.FLUTTER_VERSION }}-x64/bin/cache/artifacts/engine/windows-x64-release/"

    # 7. æºç ç¼–è¯‘vcpkgï¼ˆé¿å…é¢„ç¼–è¯‘æ–‡ä»¶æŸåï¼‰
    - name: "ğŸ“¦ Install vcpkg"
      shell: powershell
      run: |
        git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
        cd "$env:VCPKG_ROOT"
        git checkout ${{ env.VCPKG_COMMIT_ID }}
        .\bootstrap-vcpkg.bat -disableMetrics
        # éªŒè¯å®‰è£…
        .\vcpkg version
        if (-not $?) { exit 1 }

    # 8. å®‰è£…ä¾èµ–ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    - name: "ğŸ§© Install Dependencies"
      shell: powershell
      env:
        VCPKG_DEFAULT_HOST_TRIPLET: "x64-windows-static"
      run: |
        $deps = @("libvpx[core]", "libyuv[core]", "openssl[core]")
        $maxRetries = 3
        $retryDelay = 30
        
        foreach ($dep in $deps) {
          $retry = 0
          while ($retry -lt $maxRetries) {
            try {
              Write-Output "Installing $dep (Attempt $($retry+1))..."
              & "$env:VCPKG_ROOT/vcpkg" install $dep `
                --triplet x64-windows-static `
                --clean-after-build `
                --recurse
              
              if ($LASTEXITCODE -eq 0) { break }
            } catch {
              Write-Output "Failed to install $dep. Error: $_"
            }
            
            $retry++
            if ($retry -lt $maxRetries) {
              Write-Output "Retrying in $retryDelay seconds..."
              Start-Sleep -Seconds $retryDelay
            }
          }
          
          if ($retry -eq $maxRetries) {
            Write-Output "Failed to install $dep after $maxRetries attempts."
            # è¾“å‡ºæ—¥å¿—ä»¥ä¾¿è°ƒè¯•
            Get-ChildItem "$env:VCPKG_ROOT/buildtrees" -Recurse -Filter "*.log" | ForEach-Object {
              Write-Output "=== $($_.FullName) ==="
              Get-Content $_.FullName -Tail 50
              Write-Output "======================="
            }
            exit 1
          }
        }

    # 9. æ„å»ºRustDesk
    - name: "ğŸ”¨ Build RustDesk"
      shell: powershell
      run: |
        python .\build.py --portable --hwcodec --flutter --vram --skip-portable-pack
        if (-not (Test-Path "flutter/build/windows/x64/runner/Release/rustdesk.exe")) {
          Write-Output "Build failed - rustdesk.exe not found!"
          exit 1
        }

    # 10. æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
    - name: "ğŸ“¦ Package Executable"
      shell: powershell
      run: |
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Path ".\output" -Force
        
        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item -Path "flutter/build/windows/x64/runner/Release/*" -Destination ".\output" -Recurse
        
        # ä¸‹è½½å¹¶æ·»åŠ USBé‡å®šå‘é©±åŠ¨
        Invoke-WebRequest -Uri "https://github.com/rustdesk-org/rdev/releases/download/usbmmidd_v2/usbmmidd_v2.zip" -OutFile "usbmmidd_v2.zip"
        Expand-Archive "usbmmidd_v2.zip" -DestinationPath ".\usbmmidd_v2"
        Remove-Item -Path ".\usbmmidd_v2\Win32" -Recurse -ErrorAction SilentlyContinue
        Remove-Item -Path ".\usbmmidd_v2\deviceinstaller64.exe", ".\usbmmidd_v2\deviceinstaller.exe", ".\usbmmidd_v2\usbmmidd.bat" -ErrorAction SilentlyContinue
        Move-Item -Path ".\usbmmidd_v2" -Destination ".\output\usbmmidd_v2" -Force

    # 11. ä¸Šä¼ åˆ¶å“
    - name: "ğŸ“¤ Upload Artifact"
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-windows
        path: |
          output/*
        retention-days: 1
