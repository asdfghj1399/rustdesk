name: "RustDesk Windows CI (Stable)"

on:
  workflow_dispatch:
    inputs:
      clean_cache:
        description: "Clean all build caches"
        type: boolean
        default: false

env:
  VCPKG_ROOT: "C:\\vcpkg"
  VCPKG_FEATURE_FLAGS: "-binarycaching"
  RUST_BACKTRACE: "full"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
    # 1. æ¸…ç†ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    - name: "ğŸ”¥ Clean Cache"
      if: ${{ inputs.clean_cache }}
      shell: powershell
      run: |
        Remove-Item -Recurse -Force "$env:VCPKG_ROOT" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE/target" -ErrorAction SilentlyContinue

    # 2. æ£€å‡ºä»£ç ï¼ˆä½¿ç”¨ checkout@v4ï¼‰
    - name: "ğŸ“¥ Checkout Code"
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 3. è®¾ç½®Rustï¼ˆå®˜æ–¹æ¨èæ–¹å¼ï¼‰
    - name: "ğŸ¦€ Setup Rust"
      uses: actions-rust-lang/setup-rust@v1
      with:
        target: x86_64-pc-windows-msvc

    # 4. å®‰è£…vcpkg
    - name: "ğŸ“¦ Install vcpkg"
      shell: powershell
      run: |
        if (-not (Test-Path "$env:VCPKG_ROOT/vcpkg.exe")) {
          git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
          cd "$env:VCPKG_ROOT"
          git checkout 2024.04.17
          .\bootstrap-vcpkg.bat -disableMetrics
        }

    # 5. å®‰è£…ä¾èµ–ï¼ˆå¸¦ä¸­å›½é•œåƒåŠ é€Ÿï¼‰
    - name: "ğŸ§© Install Dependencies"
      shell: powershell
      env:
        VCPKG_BINARY_SOURCES: "clear;nuget,https://mirrors.ustc.edu.cn/vcpkg,read"
      run: |
        & "$env:VCPKG_ROOT/vcpkg" install @(
          "libvpx[core]",
          "libyuv[core]",
          "openssl[core]"
        ) --triplet=x64-windows --clean-after-build --recurse

    # 6. æ„å»ºé¡¹ç›®
    - name: "ğŸ”¨ Build Release"
      shell: powershell
      run: |
        $env:Path += ";$env:VCPKG_ROOT/installed/x64-windows/bin"
        cargo build --release --target x86_64-pc-windows-msvc -vv
        if (-not (Test-Path "target/release/rustdesk.exe")) {
          Write-Output "::error::Build failed!"
          exit 1
        }

    # 7. ä¸Šä¼ äº§ç‰©ï¼ˆä½¿ç”¨ upload-artifact@v4ï¼‰
    - name: "ğŸ“¦ Upload Artifact"
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-binaries
        path: |
          target/release/rustdesk.exe
          target/release/*.dll
