name: CI Pipeline with Path Fixes

on:
  workflow_dispatch:
    inputs:
      clean-build:
        description: 'Perform deep clean'
        type: boolean
        default: false

env:
  VCPKG_ROOT: C:\vcpkg  # 使用Windows原生路径格式

jobs:
  setup:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Clean workspace (PowerShell)
        if: ${{ inputs.clean-build }}
        shell: powershell
        run: |
          # 安全删除目录（Windows原生方式）
          if (Test-Path $env:VCPKG_ROOT) {
              Remove-Item -Path $env:VCPKG_ROOT -Recurse -Force -ErrorAction Stop
              Write-Output "成功清理vcpkg目录"
          } else {
              Write-Output "vcpkg目录不存在，跳过清理"
          }

          # 附加清理其他缓存
          Remove-Item -Path target -Recurse -ErrorAction SilentlyContinue
          cargo clean

      - name: Bootstrap vcpkg
        shell: cmd  # 使用CMD处理路径
        run: |
          if exist "%VCPKG_ROOT%" (
              rmdir /s /q "%VCPKG_ROOT%"
          )
          git clone https://github.com/microsoft/vcpkg.git "%VCPKG_ROOT%"
          cd "%VCPKG_ROOT%"
          .\bootstrap-vcpkg.bat

  build:
    needs: setup
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - run: cargo build --release
