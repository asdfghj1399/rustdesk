jobs:
  build-for-windows-flutter:
    name: ${{ matrix.job.target }}
    needs: [build-RustDeskTempTopMostWindow, generate-bridge]
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        job:
          - {
              target: x86_64-pc-windows-msvc,
              arch: x86_64,
              vcpkg-triplet: x64-windows-static,
              build_type: "hwcodec,flutter,vram"
            }

    env:
      RUSTFLAGS: "-C target-feature=+crt-static"
      VCPKG_DEFAULT_TRIPLET: ${{ matrix.job.vcpkg-triplet }}
      VCPKG_ROOT: C:\vcpkg

    steps:
      - name: 初始化环境变量
        shell: powershell
        run: |
          [System.Environment]::SetEnvironmentVariable('VCPKG_ROOT', 'C:\vcpkg', 'Machine')
          $env:Path += ";C:\vcpkg"

      - uses: actions/cache@v3
        name: 缓存vcpkg
        with:
          path: C:\vcpkg
          key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_COMMIT_ID }}

      - name: 安装vcpkg依赖
        shell: powershell
        run: |
          & "$env:VCPKG_ROOT\vcpkg" install \
            libvpx[core] \
            libyuv[core] \
            --triplet $env:VCPKG_DEFAULT_TRIPLET
          if (-not $?) { exit 1 }

      - name: 构建RustDesk
        shell: powershell
        run: |
          # 强制刷新依赖关系
          cargo update -p magnum-opus
          
          python .\build.py --features ${{ matrix.job.build_type }} `
            --portable `
            --skip-portable-pack `
            --vcpkg-root "$env:VCPKG_ROOT"
