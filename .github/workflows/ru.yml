name: RustDesk CI/CD (路径修正版)

on:
  workflow_dispatch:
    inputs:
      build-mode:
        description: '选择构建模式'
        type: choice
        options: [debug, release]
        default: 'release'

env:
  WORKSPACE: ${{ github.workspace }}\src  # 显式声明Windows路径

jobs:
  setup:
    name: 环境初始化
    runs-on: windows-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        path: src  # 存储到src子目录

    - name: Validate Workspace
      shell: powershell
      run: |
        # 验证工作目录存在性
        if (-not (Test-Path "$env:WORKSPACE")) {
            New-Item -Path "$env:WORKSPACE" -ItemType Directory -Force
        }
        Write-Output "##[info]工作目录验证通过: $env:WORKSPACE"

  build:
    needs: setup
    runs-on: windows-latest
    steps:
    - name: 设置编译环境
      shell: powershell
      run: |
        # 使用显式路径声明
        $buildRoot = "$env:WORKSPACE"
        
        # 验证路径格式
        if ($buildRoot -notmatch '^[A-Z]:\\') {
            Write-Output "::error::无效的路径格式: $buildRoot"
            exit 1
        }

        # 设置环境变量
        $env:Path += ";C:\Program Files\LLVM\bin"
        Set-Location $buildRoot
        Write-Output "当前工作目录: $(Get-Location)"
        
        # 调试信息
        Get-ChildItem | Format-Table Name

    - name: 构建项目
      shell: powershell
      working-directory: ${{ env.WORKSPACE }}  # 使用环境变量定义路径
      run: |
        cargo build --${{ inputs.build-mode }} --bin rustdesk
