name: CI Build

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  VCPKG_COMMIT: "d619c9be4bcd170f0f7d6b705a72aadf8d5b0aab" # 有效的40位commit hash
  VCPKG_ROOT: C:\vcpkg

jobs:
  setup-vcpkg:
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ env.VCPKG_ROOT }}
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT }} # 直接使用完整SHA
          setupOnly: true

  build:
    needs: setup-vcpkg
    runs-on: windows-2022
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Validate vcpkg
        shell: pwsh
        run: |
          # 验证commit hash格式
          if (-not ($env:VCPKG_COMMIT -match '^[0-9a-f]{40}$')) {
              Write-Error "Invalid vcpkg commit format: $env:VCPKG_COMMIT"
              exit 1
          }
          
          # 验证vcpkg安装
          if (-not (Test-Path "$env:VCPKG_ROOT\.git")) {
              Write-Error "vcpkg repository not initialized"
              exit 1
          }

      - name: Build with vcpkg
        shell: pwsh
        run: |
          # 显示vcpkg版本信息
          & "$env:VCPKG_ROOT\vcpkg" version --debug
          
          # 后续构建命令...
