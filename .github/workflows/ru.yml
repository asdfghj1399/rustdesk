name: Build RustDesk (Windows)

on:
  workflow_dispatch: {}  # 明确启用手动触发
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  VERSION: "1.3.9"
  FLUTTER_VERSION: "3.24.5"
  RUST_VERSION: "1.75.0"
  VCPKG_COMMIT_ID: "6f29f12e82a8293156836ad81cc9bf5af41fe836"
  VCPKG_DEFAULT_TRIPLET: "x64-windows-static"
  VCPKG_FORCE_SYSTEM_BINARIES: "1"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies (Fixed)
      shell: powershell
      run: |
        # 修复1：完整的Chocolatey安装流程
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        $chocoScript = Join-Path $env:TEMP 'choco-install.ps1'
        Invoke-WebRequest -Uri 'https://community.chocolatey.org/install.ps1' -OutFile $chocoScript -UseBasicParsing
        & $chocoScript
        Start-Sleep -Seconds 5  # 等待环境更新
        
        # 修复2：正确处理环境刷新
        Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1" -Force
        $env:PATH = [System.Environment]::GetEnvironmentVariable('PATH', 'Machine') + ';' + 
                    [System.Environment]::GetEnvironmentVariable('PATH', 'User')
        
        # 修复3：避免重复安装LLVM
        choco upgrade -y cmake git python
        choco install -y llvm --version=15.0.6 --force
        choco install -y nasm

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc

    - name: Setup vcpkg
      shell: powershell
      run: |
        $vcpkgDir = "$env:GITHUB_WORKSPACE\vcpkg"
        
        # 清理旧目录
        if (Test-Path $vcpkgDir) {
            Remove-Item -Recurse -Force $vcpkgDir
        }
        
        # 修复4：更可靠的vcpkg克隆方式
        git config --global core.longpaths true
        git clone https://github.com/microsoft/vcpkg $vcpkgDir
        cd $vcpkgDir
        git checkout $env:VCPKG_COMMIT_ID
        
        # 验证并初始化
        if (-not (Test-Path "$vcpkgDir\bootstrap-vcpkg.bat")) {
            throw "vcpkg bootstrap files missing"
        }
        & "$vcpkgDir\bootstrap-vcpkg.bat" -disableMetrics
        & "$vcpkgDir\vcpkg" integrate install

    - name: Install vcpkg dependencies
      shell: powershell
      run: |
        cd "$env:GITHUB_WORKSPACE\vcpkg"
        $ErrorActionPreference = "Stop"
        
        # 分步安装依赖
        .\vcpkg install --triplet=$env:VCPKG_DEFAULT_TRIPLET libvpx
        .\vcpkg install --triplet=$env:VCPKG_DEFAULT_TRIPLET libyuv
        .\vcpkg install --triplet=$env:VCPKG_DEFAULT_TRIPLET openssl
        .\vcpkg install --triplet=$env:VCPKG_DEFAULT_TRIPLET opus
        .\vcpkg install --triplet=$env:VCPKG_DEFAULT_TRIPLET ffmpeg[core,avcodec,avformat,swresample,swscale]
        .\vcpkg install --triplet=$env:VCPKG_DEFAULT_TRIPLET aom[core]

    - name: Build RustDesk
      shell: powershell
      run: |
        python .\build.py --flutter --vram --portable --skip-portable-pack

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-binaries
        path: |
          flutter\build\windows\x64\runner\Release\rustdesk.exe
        retention-days: 7
