name: RustDesk CI/CD

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型'
        type: choice
        options: [debug, release]
        default: 'release'

env:
  VCPKG_ROOT: "C:\\vcpkg"
  VCPKG_DEFAULT_TRIPLET: "x64-windows-static"

jobs:
  setup:
    name: 环境准备
    runs-on: windows-latest
    steps:
    - name: 安装VCPKG
      shell: powershell
      run: |
        git clone https://github.com/microsoft/vcpkg $env:VCPKG_ROOT
        & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
        & "$env:VCPKG_ROOT\vcpkg" integrate install

    - name: 安装依赖库
      shell: powershell
      run: |
        & "$env:VCPKG_ROOT\vcpkg" install \
          libvpx[core]:$env:VCPKG_DEFAULT_TRIPLET \
          libyuv[core]:$env:VCPKG_DEFAULT_TRIPLET \
          openssl[core]:$env:VCPKG_DEFAULT_TRIPLET

  build:
    needs: setup
    runs-on: windows-latest
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: 构建项目
      shell: powershell
      env:
        VCPKGRS_DYNAMIC: "1"
        RUSTFLAGS: "-C target-feature=+crt-static"
      run: |
        cargo build --release --features "vcpkg" -v

    - name: 上传产物
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-bin
        path: |
          target/release/rustdesk.exe
          target/release/*.dll
