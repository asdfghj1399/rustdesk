name: "RustDesk Windows CI (Stable)"

on:
  workflow_dispatch:
    inputs:
      clean_cache:
        description: "Clean all build caches (vcpkg + cargo)"
        type: boolean
        default: false

env:
  VCPKG_ROOT: "${{ runner.temp }}/vcpkg"  # ä½¿ç”¨ä¸´æ—¶ç›®å½•é¿å…æƒé™é—®é¢˜
  VCPKG_FEATURE_FLAGS: "-binarycaching"   # ç¦ç”¨äºŒè¿›åˆ¶ç¼“å­˜ï¼ˆç¡®ä¿æºç ç¼–è¯‘ï¼‰
  RUST_BACKTRACE: "full"                  # å¯ç”¨å®Œæ•´çš„Rusté”™è¯¯å›æº¯

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 90

    steps:
    # 1. æ¸…ç†ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    - name: "ğŸ”¥ Nuclear Clean (Optional)"
      if: ${{ inputs.clean_cache }}
      shell: powershell
      run: |
        Remove-Item -Recurse -Force "$env:VCPKG_ROOT" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "$env:GITHUB_WORKSPACE/target" -ErrorAction SilentlyContinue

    # 2. æ£€å‡ºä»£ç ï¼ˆåŒ…å«å­æ¨¡å—ï¼‰
    - name: "ğŸ“¥ Checkout Repository"
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 3. è®¾ç½®Rustå·¥å…·é“¾
    - name: "ğŸ¦€ Setup Rust"
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        targets: x86_64-pc-windows-msvc
        override: true

    # 4. å®‰è£…vcpkgï¼ˆé”å®šç¨³å®šç‰ˆæœ¬ï¼‰
    - name: "ğŸ“¦ Install vcpkg"
      shell: powershell
      run: |
        if (-not (Test-Path "$env:VCPKG_ROOT/vcpkg.exe")) {
          Write-Output "::group::Cloning vcpkg"
          git clone https://github.com/microsoft/vcpkg "$env:VCPKG_ROOT"
          cd "$env:VCPKG_ROOT"
          git checkout 2024.04.17  # é”å®šå·²çŸ¥ç¨³å®šç‰ˆæœ¬
          .\bootstrap-vcpkg.bat -disableMetrics
          Write-Output "::endgroup::"
        }
        & "$env:VCPKG_ROOT/vcpkg" version

    # 5. å®‰è£…ä¾èµ–åº“ï¼ˆè‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼‰
    - name: "ğŸ§© Install Dependencies"
      shell: powershell
      run: |
        $maxRetries = 3
        $packages = @("libvpx[core]", "libyuv[core]", "openssl[core]")
        
        foreach ($pkg in $packages) {
          $attempt = 0
          while ($attempt -lt $maxRetries) {
            try {
              Write-Output "::group::Installing $pkg (Attempt $($attempt+1))"
              & "$env:VCPKG_ROOT/vcpkg" install $pkg `
                --triplet=x64-windows `
                --clean-after-build `
                --recurse `
                --debug
              
              if ($LASTEXITCODE -eq 0) {
                Write-Output "::endgroup::"
                break
              }
            } catch {
              Write-Output "::warning::Install failed: $_"
            }
            Write-Output "::endgroup::"
            $attempt++
            if ($attempt -lt $maxRetries) {
              Start-Sleep -Seconds (30 * $attempt)
            }
          }
          
          if ($attempt -eq $maxRetries) {
            Write-Output "::error::Failed to install $pkg after $maxRetries attempts"
            exit 1
          }
        }

    # 6. æ„å»ºé¡¹ç›®ï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
    - name: "ğŸ”¨ Build Release"
      shell: powershell
      run: |
        $env:Path += ";$env:VCPKG_ROOT/installed/x64-windows/bin"
        cargo build --release `
          --target x86_64-pc-windows-msvc `
          --verbose `
          2>&1 | Tee-Object -FilePath build.log
        
        if (-not (Test-Path "target/release/rustdesk.exe")) {
          Write-Output "::error::Build failed! Last 50 lines:"
          Get-Content build.log -Tail 50 | ForEach-Object { Write-Output $_ }
          exit 1
        }

    # 7. æ”¶é›†æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
    - name: "ğŸ“¦ Package Artifacts"
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: rustdesk-binaries
        path: |
          target/release/rustdesk.exe
          target/release/*.dll
