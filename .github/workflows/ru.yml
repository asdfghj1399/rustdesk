name: Build RustDesk (Windows)

on:
  workflow_dispatch: {}  # 明确启用手动触发
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  VERSION: "1.3.9"
  FLUTTER_VERSION: "3.24.5"
  RUST_VERSION: "1.75.0"
  VCPKG_COMMIT_ID: "6f29f12e82a8293156836ad81cc9bf5af41fe836"
  VCPKG_DEFAULT_TRIPLET: "x64-windows-static"
  VCPKG_FORCE_SYSTEM_BINARIES: "1"

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      shell: powershell
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1" -Force
        $env:PATH = [System.Environment]::GetEnvironmentVariable('PATH', 'Machine') + ';' + 
                    [System.Environment]::GetEnvironmentVariable('PATH', 'User')
        
        choco install -y cmake git python llvm --version=15.0.6 nasm

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: x86_64-pc-windows-msvc

    - name: Setup vcpkg (Fixed)
      shell: powershell
      run: |
        $vcpkgDir = "$env:GITHUB_WORKSPACE\vcpkg"
        
        # 清理旧目录
        if (Test-Path $vcpkgDir) {
            Remove-Item -Recurse -Force $vcpkgDir
        }
        
        # 修复克隆方式
        git config --global core.longpaths true
        git clone https://github.com/microsoft/vcpkg $vcpkgDir
        cd $vcpkgDir
        git checkout $env:VCPKG_COMMIT_ID
        
        # 验证并初始化
        if (-not (Test-Path "$vcpkgDir\bootstrap-vcpkg.bat")) {
            throw "vcpkg bootstrap files missing"
        }
        & "$vcpkgDir\bootstrap-vcpkg.bat" -disableMetrics
        & "$vcpkgDir\vcpkg" integrate install

    - name: Install vcpkg dependencies (Fixed)
      shell: powershell
      run: |
        $vcpkgDir = "$env:GITHUB_WORKSPACE\vcpkg"
        $ErrorActionPreference = "Stop"
        
        # 修复1：使用完整路径调用vcpkg
        $vcpkgExe = "$vcpkgDir\vcpkg"
        
        # 修复2：正确的参数格式
        & $vcpkgExe install libvpx --triplet=$env:VCPKG_DEFAULT_TRIPLET
        & $vcpkgExe install libyuv --triplet=$env:VCPKG_DEFAULT_TRIPLET
        & $vcpkgExe install openssl --triplet=$env:VCPKG_DEFAULT_TRIPLET
        & $vcpkgExe install opus --triplet=$env:VCPKG_DEFAULT_TRIPLET
        
        # 修复3：分步安装复杂依赖
        & $vcpkgExe install ffmpeg --triplet=$env:VCPKG_DEFAULT_TRIPLET `
          --feature=core,avcodec,avformat,swresample,swscale
        
        & $vcpkgExe install aom --triplet=$env:VCPKG_DEFAULT_TRIPLET --feature=core

    - name: Build RustDesk
      shell: powershell
      run: |
        python .\build.py --flutter --vram --portable --skip-portable-pack

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-binaries
        path: |
          flutter\build\windows\x64\runner\Release\rustdesk.exe
        retention-days: 7
