- name: Install system dependencies
  shell: powershell
  run: |
    $ErrorActionPreference = "Stop"
    Set-ExecutionPolicy Bypass -Scope Process -Force
    $ProgressPreference = 'SilentlyContinue'
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

    # NASM 安装部分修复
    $nasmUrls = @(
        "https://www.nasm.us/pub/nasm/stable/win64/nasm-${env:NASM_VERSION}-win64.zip",
        "https://ftp.osuosl.org/pub/nasm/releasebuilds/${env:NASM_VERSION}/win64/nasm-${env:NASM_VERSION}-win64.zip"
    )

    foreach ($url in $nasmUrls) {
        try {
            Write-Output "正在尝试从 $url 下载NASM..."
            Invoke-WebRequest -Uri $url -OutFile nasm.zip -TimeoutSec 30
            Expand-Archive -Path nasm.zip -DestinationPath C:\nasm -Force
            
            if (Test-Path "C:\nasm\nasm.exe") {
                $env:PATH = "C:\nasm;${env:PATH}"
                Write-Output "NASM安装成功"
                break
            }
        } catch {
            Write-Output "下载失败: $($_.Exception.Message)"
            continue
        }
    }

    if (-not (Test-Path "C:\nasm\nasm.exe")) {
        throw "NASM 安装失败: 所有镜像源均不可用"
    }
